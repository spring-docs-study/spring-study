# 9장 스프링 웹 스코프

- 스프링이 컨텍스츠에서 빈을 관리하는 몇몇 새로운 방법
  - 싱글톤 : 프레임워크가 컨텍스트에서 이름으로 각 인스턴스를 고유하게 식별하는 스프링의 기본 빈 스코프다.
  - 프로토타입 : 프레임워크가 타입만 관리하고 요청받을 때마다 해당 클래스의 새 인스턴스를 생성하는 스프링 빈 스코프이다.


### 웹 스코프란
 - 웹 스코프(WebScope)는 주로 웹 개발과 관련된 기술적 개념을 의미합니다.
 - 웹 애플리케이션만 관련된 빈 스코프들을 사용할 수 있다.

1. 요청 스코프 : 스프링은 각 HTTP 요청에 대해 빈 클래스의 인스턴스를 생성한다. 이 인스턴스는 해당 HTTP 요청에서만 존재한다.
2. 세션 스코프 : 스프링은 인스턴스를 생성하고 전체 HTTP 세션동안 서버의 메모리에 이 인스턴스를 클라이언트의 세션과 연결한다.
3. 애플리케이션 스코프 : 인스턴스는 앱의 컨텍스트에서 고유하며, 앱이 실행되는 동안 사용할 수 있다.


> 그림 9-1 웹 스코프를 구현하는 수행 단계
> ![그림 9-1.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-1.jpg)

## 9.1 스프링 웹 앱에서 요청 스코프 사용

 - 스프링 웹 앱에서 요청 스코프 빈의 사용 방법을 알아본다.
   - 웹 앱은 HTTP 요청과 응답에 중점을 둔다. 그 때문에 스프링이 HTTP 요청과 연관된 빈 라이프사이클을 관리하는 방법을 제공한다면 특정 기능을 웹 앱에서 관리하기가 더 쉬워진다.
   - 요청 스코프 빈은 스프링에서 관리하는 객체로, 프레임워크는 HTTP 요청마다 새로운 인스턴스를 생성한다.
   - 앱은 인스턴스를 생성한 요청에서만 해당 인스턴스를 사용할 수 있다.
   - 각각의 새로운 HTTP 요청은 동일한 클래스의 다른 인스턴스를 생성하고 사용한다.


> 그림 9-2 요청 스코프 빈의 사용 방법
> ![그림 9-2.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-2.jpg)

> ### 요청 스코프 빈의 핵심 관점
> ![요청 스코프 빈의 핵심 관점.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\요청 스코프 빈의 핵심 관점.jpg)


> 그림 9-3 사용자 이름과 비밀번호를 묻는 로그인 양식이 포함된 웹 페이지
> ![그림 9-3.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-3.jpg)



> 그림 9-4 로그인 구현
> ![그림 9-4.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-4.jpg)


> 그림 9-5 구현한 컨트롤러 클래스와 뷰 사이의 연결
> ![그림 9-5.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-5.jpg)

로그인 컨트롤러가 속성에 세부 정보를 저장하지 않는 한 로그인 컨트롤러의  스코프를 변경할 필요 없다. 하지만 로그인 로직을 구현해야 한다. 로그인 로직은 사용자 자격 증명에 따라 달라지며, 이런 자격 증명에서는 두 가지 사항을 고려해야 한다.

1. 자격 증명은 민감한 세부 정보이므로 로그인 요청보다 오랜 시간 앱 메모리에 저장해서는 안 된다.
2. 다른 자격 증명을 가진 더 많은 사용자가 동시에 로그인을 시도할 수 있다.

이 두 사항을 고려할 때, 로그인 로직을 구현하려고 빈을 사용하려면 각 인스턴스가 HTTP 요청마다 고유한지 확인해야 한다. 이를 위해 요청 스코프 빈을 사용해야 한다. 


> 그림 9-6 요청 스코프 빈인 LoginProcessor 추가
> ![그림 9-6.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-6.jpg)




> 그림 9-7 애플리케이션 실행 후 localhost:8080 접속
> ![그림 9-7.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-7.jpg)


## 9.2 스프링 웹 앱에서 세션 스코프 사용

 - 세션 스코프 빈 이란
   - 스프링에서 관리되는 객체
   - 스프링이 인스턴스를 생성하고 이를 HTTP 세션에 연결하는 역할

1. 클라이언트가 서버에 요청을 보내면 서버는 세션의 전체 기간 동안 이 요청을 위한 메모리 공간을 예약한다.
2. 스프링은 특정 클라이언트에 대해 HTTP 세션이 생성될 때 세션 스코프 빈의 인스턴스를 생성한다.
3. 이 인스턴스는 HTTP 세션이 활성화 되어 이ㅛ는 동안 동일한 클라이언트에서 재사용될 수 있다.
4. 세션 스코프 빈 속성에 저장된 데이터는 HTTP 세션 동안 클라이언트의 모든 요청에 사용할 수 있다.
5. 이런 데이터 저장 방식을 사용하면 사용자가 앱의 웹 페이지를 서핑하는 동안 수행하는 작업 정보의 저장이 가능하다.


> 그림 9-8
> ![그림 9-8.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-8.jpg)


>그림 9-9 세션 스코프 빈을 나타내는  그림 9-8과 요청 스코프 빈을 나타내는 그림 9-2의 비교
> ![그림 9-9.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-9.jpg)


세션 스코프 빈을 사용하여 구현할 수 있는 몇 가지 기능에는 다음 예가 있다.
 - 로그인 : 인증된 사용자가 앱의 여러 부분을 탐색하고 요청 전송하는 동안 그 사용자의 세부 정보를 유지한다.
 - 온라인 쇼핑 장밧구니 : 사용자가 앱의 여러 곳을 방문하여 장바구니에 추가할 제품을 검색한다. 장바구니는 고객이 추가한 모든 제품을 보관한다.

> 세션 스코프 빈의 핵심 관점
> ![세션 스코프 빈의 핵심 관점.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\세션 스코프 빈의 핵심 관점.jpg)


사용자 로그인을 인식하고 사용자가 앱의 다른 웹 페이지에 액세스하는 동안 로그인한 사용자로 인식하려면 세션 스코프 빈을 계속 사용해야 한다.

9.1절에서 구현한 애플리케이션을 로그인한 사용자만 액세스할 수 있는 웹 페이지를 표시하도록 변경하기 위해 수행할 단계
1. 로그인한 사용자의 상세 정보를 유지할 세션 범위의 빈을 생성한다.
2. 사용자가 로그인한 후에만 액세스할 수 있는 웹 페이지를 만든다.
3. 사용자가 먼저 로그인하지 않으면 2. 에서 만든 웹 페이지에 액세스할 수 없게 한다.
4. 인증에 성공하면 사용자를 로그인에서 메인 페이지로 리디렉션한다.


> 그림 9-10 세션 스코프 빈으로 로그인한 사용자만 액세스할 수 있는 웹 페이지를 표시하도록 변경하기 위해 수행할 단계
> ![그림 9-10.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-10.jpg)


> 그림 9-11 예제에서 구현된 로그인 흐름도
> ![그림 9-11.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-11.jpg)


> 그림 9-12 메인 페이지의 로직
> ![그림 9-12.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-12.jpg)


## 9.3 스프링 웹 앱에서 애플리케이션 스코프 사용

애플리케이션 스코프(Application Scope)는 웹 애플리케이션에서 공유 데이터를 저장하는 범위를 의미합니다. 이 범위는 애플리케이션이 시작될 때 생성되고 애플리케이션이 종료될 때까지 유지되며, 모든 사용자와 모든 세션에 걸쳐 데이터를 공유할 수 있습니다. 일반적으로 애플리케이션 스코프는 웹 애플리케이션의 모든 요청에 대해 전역적으로 접근 가능한 데이터를 저장하는 데 사용됩니다.
 - 애플리케이션 스코프는 싱글톤 작동 방식과 비슷하다. 차이점은 컨텍스트에 동일한 타입의 인스턴스가 없다는 것과 웹 스코프의 라이프사이클을 논의할 때 항상 HTTP 요청을 참조 기준점으로 사용한다는 것이다.


> 그림 9-14 애플리케이션 스코프 이해하기
> ![그림 9-14.jpg](\김민섭\springsutdy\src\main\resources\md파일\스터디 5회\그림 9-14.jpg)


## 9.4 요약
 - 싱글톤과 프로토타입 빈 스코프 외에도 스프링 웹 앱에서 사용할 수 있는 세가지 빈 스코프로 더 많은 이점을 얻을 수 있다. 이런 스코프는 웹 앱에서만 의미가 있어 웹 스코프라고 한다.
   - 요청 스코프 : 스프링은 HTTP 요청별로 빈 인스턴스를 생성한다.
   - 세션 스코프 : 스프링은 클라이언트의 HTTP 세션별로 빈 인스턴스를 생성한다. 동일 클라이언트의 여러 요청에서 동일한 인스턴스를 공유할 수 있다.
   - 애플리케이션 스코프 : 해당 빈에 대해 애플리케이션 전체에서 하나의 인스턴스만 존재한다.클라이언트의 모든 요청은 이 인스턴스에 액세스할 수 있다.
 - 스프링은 요청 스코프가 지정된 빈 인스턴스가 한 HTTP 요청에서만 액세스되도록 보장한다. 따라서 동시성 관련 문제를 걱정할 필요 없이 인스턴스 속성을 사용할 수 있으며, 앱 메모리를 다 소진할 염려도 없다. 수명이 짧기 때문에 이 인스턴스는 HTTP 요청이 종료되면 가비지 컬렉션될 수 있다.
 - 스프링은 각 HTTP 요청에 대해 요청 스코프 빈의 인스턴스를 생성하며, 이 작업은 매우 빈번히 발생하므로 생성자 또는 @PostConstruct 메서드에서 복잡한 로직을 구현해서 인스턴스 생성을 어렵게 만들지 않는 것이 좋다.
 - 스프링은 세션 스코프의 빈 인스턴스를 클라이언트의 HTTP 세션에 연결한다. 이 세션 스코프의 빈 인스턴스를 사용하면 동일한 클라이언트에서 오는 여러 HTTP 요청간에 데이터를 공유할 수 있다.
 - 동일한 클라이언트라고 하더라도 클라이언트는 동시에 HTTP 요청을 보낼 수 있다. 여러 요청이 세션 스코프 인스턴스의 데이터를 변경한다면 경쟁 조건 시나리오에 빠질 수 있다. 따라서 이런 상황을 고려하여 이를 피하거나 코드를 동기화해서 동시성을 지원해야 한다.
 - 애플리케이션 스코프 빈 인스턴스의 사용은 피하는 것이 좋다. 애플리케이션 스코프 빈 인스턴스는 모든 웹 앱 요청으로 공유되므로, 모든 쓰기 작업에는 일반적으로 동기화가 필요하려 병목 현상이 발생하고 앱 성능에 큰 영향을 미친다. 또 이런 빈은 앱 자체만큼 오랜 기간 앱 메모리에 상주하므로 가비지 컬렉션이 불가능하다.
 - 세션 스코프 빈과 애플리케이션 스코프 빈 모두 요청의 독립성을 저해한다. 이는 애플리케이션이 요청에 필요한 상태를 관리하거나 앱이 상태형임을 의미한다. 상태형 앱은 다양한 문제를 야기하므로 피하는 것이 상책이다. 

